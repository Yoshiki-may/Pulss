2025-12-11 議事録

- バックエンド環境変数ロードを整理し、`python-dotenv` で `.env` を確実に読み込むよう `backend/main.py` を修正。起動時に OPENAI_API_KEY が設定されているかを INFO ログで確認できるようにした。
- OpenAI 呼び出し時にキー未設定でフォールバックしていた問題を解消。`PulssChatService._call_openai` で毎回 `os.getenv("OPENAI_API_KEY")` を再取得するようにし、キー有無のログを詳細化。OpenAI 応答の先頭 30 文字を DEBUG ログに出すようにした（キー本体は非表示）。
- PULSS SYSTEM のシステムプロンプトを日本語（です・ます調）に統一し、ミッション/必須スロット/禁止事項、STEP0 導入テンプレートを記載。初回メッセージ生成指示を日本語で STEP0 の導入文のみ返すように変更。
- フロント `pulssChatService` のベースURLデフォルトを `http://localhost:8000` に変更し、エラー時に HTTP ステータスやボディを含めてハンドリングできるよう改善。チャット画面で 404 とそれ以外を適切に出し分けられるようにした。

1. パルスURL発行〜チャット画面まで

ダッシュボードから
「パルスURL発行」→ /pulss-system/{token} 画面に遷移 できるところまで確認。

フロントの PulssSystemChatPage.tsx と
バックエンドの PulssChatService / api.py の構造を一緒に確認。

/api/clients/{id}/pulss-link で URL が発行されること、
/api/pulss-chat/start-from-link/{token} でセッション開始、
/api/pulss-chat/sessions/{session_id}/messages でメッセージ送受信、
というフローを整理。

2. 「サーバーエラー」〜 500 問題の解消

最初は URL に飛ぶと サーバーエラー表示（500）になっていた。

services.py / api.py を読みながら、

リンクが見つからないときの 404

OpenAI や DB まわりで例外が出たときの 500
の切り分けロジックを確認。

ログを見て、セッション作成までは成功している ことをチェックしつつ原因を絞り込み。

3. OPENAI_API_KEY が読めていない問題

ログに
OPENAI_API_KEY not set; skip call
と出ており、実際には OpenAI に投げずに「回答を生成できませんでした」で返っている状態だと判明。

対応として Cursor（Codex）に頼んで、バックエンドを修正：

backend/main.py に python-dotenv を使った load_dotenv() を追加。

requirements.txt に python-dotenv==1.0.1 を追加。

.env.example に OPENAI_API_KEY と PULSS_OPENAI_MODEL を追記。

そのうえで、

.env の場所が Pulss System/app/backend/.env であることを確認。

python の対話モードで load_dotenv + os.getenv を試しながら、
本当にキーが読めているかどうか をチェック。

それでも .env からは読めていないことが分かったため、
ひとまず PowerShell のシェル環境に直接環境変数をセット する方法に切り替え：

$env:OPENAI_API_KEY = "sk-......"
$env:PULSS_OPENAI_MODEL = "gpt-4o-mini"
uvicorn main:app --reload


再起動後のログで
[pulss] OPENAI_API_KEY loaded = True
と出ていることを確認 → OpenAI 呼び出しが有効になった。

4. 初回メッセージが返ってくるところまで到達

新しく発行した URL を開くと、
英語のウェルカムメッセージが表示される状態 まで到達。

これで

フロント

バックエンド

OpenAI API
の 配線が全部つながっていることを確認 できた。

5. でも英語… → プロンプト設計の見直し

英語になっている理由を一緒に確認：

pulss_prompt.py の PULSS_SYSTEM_PROMPT がまだ英語寄り。

start_session_from_token 内の user メッセージも英語で
"Start the session and send the introduction message (STEP0)."
と指示している。

そこで今後の修正方針として：

PULSS_SYSTEM_PROMPT を、
今日送ってくれた長い仕様（ロール / ミッション / スロット / STEP0 など）ベースの 日本語プロンプト に書き換える。

start_session_from_token の最初の user メッセージも
「STEP0 の導入文を日本語で出して」と指示する日本語に変更する。

Cursor / Codex に渡すべきプロンプト文も一緒に整理した
（「pulss_prompt.py と services.py を開いて、PULSS_SYSTEM_PROMPT をこう変えて…」という形）