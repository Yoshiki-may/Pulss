# Pulss System これまでの流れ（2025-12-07時点）

## 全体ゴール
- SNSニュースを自動取得 → 要約・ラベル付け → ダッシュボードに送信する仕組みを構築。
- n8n でワークフロー化し、AWS EC2（Amazon Linux 2023）上で n8n・フロント・バックエンドを動かす。

## 時系列サマリと対応
1) n8n ローカル設計  
   - フロー: RSS → JS 整形 → LLM 要約/ラベル → HTTP POST `/api/sns-news`。  
   - エラー: `Request path contains unescaped characters`  
     - 対応: RSS URL の日本語/スペースを URL エンコード。  
   - エラー: `Rate limit reached for gpt-4o-mini`（OpenAI 無料枠）  
     - 対応: 本番運用ではクレカ登録＋日次上限設定が必要と確認。

2) AWS EC2 構築  
   - AMI: Amazon Linux 2023, t3.small。  
   - セキュリティグループ: 22/80/5678/8000/5173 を開発用途で開放。  
   - SSH 接続: `ssh -i Pulss-key.pem ec2-user@<IP>`。Windows では chmod 不要、fingerprint を `yes` で登録すればOK。

3) n8n セットアップ（EC2）  
   - node/npm を dnf で導入後、`sudo npm install -g n8n`。  
   - `n8n` 起動。HTTP アクセス時の secure cookie 警告 → 開発は `N8N_SECURE_COOKIE=false` で回避、本番は HTTPS+ドメインで解決。

4) フロント（Vite+React）検証（EC2クローン）  
   - `git clone Yoshiki-may/Pulss`, `npm install`, `npm run build`, `npm run dev -- --host 0.0.0.0 --port 5173` で起動。  
   - 画面真っ白 → コード側の問題と判断。

5) フロント修正（ローカル）  
   - 文字化けをすべて修正（UTF-8）、コンポーネントやアラートの日本語を正常化。  
   - SNSニュース取得を API 呼び出しに変更（失敗時はモックへフォールバック）。  
   - `.env` に `VITE_API_BASE_URL=http://3.107.236.7:8000` を追加。  
   - `npm run build` 成功を確認。

6) バックエンド最小実装（FastAPI）  
   - `backend/main.py`: `GET /api/health`, `POST /api/sns-news`, `GET /api/sns-news`（フィルタ付き）, `GET /api/sns-news/{id}`。  
   - インメモリ保存（暫定）。  
   - CORS: `http://3.107.236.7:5173` / `http://3.107.236.7:8000` / localhost を許可。  
   - 依存: `fastapi`, `uvicorn` (`backend/requirements.txt`)。  
   - 起動例: `uvicorn main:app --host 0.0.0.0 --port 8000`。

7) Python 3.9 互換エラーの解消  
   - 発生: Pydantic が `Optional[SnsPlatform | Literal["all"]]` を評価できず TypeError（`unsupported operand type(s) for |`）。  
   - 原因: Python 3.9 で `|` 型結合は未サポート。  
   - 対応: `from __future__ import annotations` を追加し、Union/Literal で書き直し（`Optional[Union[SnsPlatform, Literal["all"]]]` など）。`git push origin main` 済み。

8) Git 初回コミットと push  
   - `.gitignore` 追加（Obsidian, node_modules, dist, .venv など除外）。  
   - `git config user.name "Yoshiki-may"`, `git config user.email "brainsystem@shishayuenchi.com"` 設定。  
   - 初回コミット・修正コミットを `origin/main` に push 完了。

## 主要課題と解決・回避策
- RSS URL エラー: 日本語/スペースを URL エンコード。  
- OpenAI レート制限: 無料枠では足りない。クレカ登録＋日次上限設定で本番運用。  
- フロント文字化け: 保存エンコードを UTF-8 に統一し文言を再入力。  
- 画面真っ白: コンポーネント文言・API 周りを修正し、ビルド成功を確認。  
- CORS: FastAPI で許可オリジンを明示（localhost, EC2 IP）。  
- n8n secure cookie 警告: 開発は `N8N_SECURE_COOKIE=false`、本番は HTTPS + 正式ドメイン。  
- Python 3.9 型エラー: `Union`/`Literal` を用い、`|` を使わない書き方に変更。

## これからやること（本筋）
1. EC2 でバックエンド起動  
   ```bash
   cd backend
   uvicorn main:app --host 0.0.0.0 --port 8000
   ```
2. フロント起動/確認  
   ```bash
   cd "Pulss system/Code/Pulss-main"
   npm run dev -- --host 0.0.0.0 --port 5173
   # または dist を Nginx で配信
   ```
3. n8n から `/api/sns-news` に POST して、フロントでニュースが表示されることを確認。  
4. （任意）本番運用に向けて DB 永続化（SQLite/PostgreSQL）と認証導入、systemd+Nginx で常駐化。  
5. OpenAI の課金設定と日次上限を実施。
